<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="深思博文">
    <meta name="keyword"  content="深思博文">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        分布式一致性基础 - 深思博文 | Neo&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <!--<i> Talk is cheap, show me the article. </i> -->
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
	<!--
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Hyw</i>
        </div>
    </div>
	--> 
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例1：下订单和扣库存"><span class="toc-text">案例1：下订单和扣库存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例2：转账"><span class="toc-text">案例2：转账</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是分布式一致性问题"><span class="toc-text">什么是分布式一致性问题?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解决一致性问题的思路"><span class="toc-text">解决一致性问题的思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#酸碱平衡理论"><span class="toc-text">酸碱平衡理论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP"><span class="toc-text">CAP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE"><span class="toc-text">BASE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式一致性协议"><span class="toc-text">分布式一致性协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#两阶段提交"><span class="toc-text">两阶段提交</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三阶段提交"><span class="toc-text">三阶段提交</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式一致性问题解决方案——paxos"><span class="toc-text">分布式一致性问题解决方案——paxos</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文献"><span class="toc-text">参考文献</span></a></li></ol>
</div>

    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <!-- <i> Talk is cheap, show me the article. </i> -->
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        分布式一致性基础
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-09-23 10:33:23</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#算法" title="算法">算法</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#分布式一致性" title="分布式一致性">分布式一致性</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><h2 id="案例1：下订单和扣库存"><a href="#案例1：下订单和扣库存" class="headerlink" title="案例1：下订单和扣库存"></a>案例1：下订单和扣库存</h2><p>下订单和扣库存如何保持一致是电商系统中的一个经典问题。如果先下订单，扣库存失败，那么将导致超卖；如果下订单不成功，扣库存成功，那么会导致少买。这两种情况都会导致运营成本增加，在严重情况下需要赔付。</p>
<h2 id="案例2：转账"><a href="#案例2：转账" class="headerlink" title="案例2：转账"></a>案例2：转账</h2><p>转账是经典的不一致案例，设想一下银行为你处理一笔转账，扣减你账户上的余额，然后增加别人账户的余额；如果扣减你的账户余额成功，增加别人账户余额失败，那么你就会损失这笔资金。反过来，如果扣减你的账户余额失败，增加别人账户余额成功，那么银行就会损失这笔资金，银行需要赔付。对于资金处理系统来说，上面任何一种场景都是不允许发生的，一旦发生就会有资金损失，后果是不堪设想的，严重情况会让一个公司瞬间倒闭。</p>
<h1 id="什么是分布式一致性问题"><a href="#什么是分布式一致性问题" class="headerlink" title="什么是分布式一致性问题?"></a>什么是分布式一致性问题?</h1><p>说到分布式，就不得不说互联网时代谈论最多的话题就是拆分。拆分一般分为水平拆分和垂直拆分，这两种拆分不单指数据库或者缓存的拆分，主要是表达一种分而治之的思想和逻辑。</p>
<ul>
<li>水平拆分</li>
</ul>
<p>指同一个功能由于单机节点无法满足性能需求，需要扩展成为多节点，多个节点具有一致的功能，组成一个服务池，一个节点服务一部分的请求量，团结起来共同处理大规模高并发的请求量</p>
<ul>
<li>垂直拆分</li>
</ul>
<p>指的是按照功能拆分，秉着“专业的人干专业的事儿”的原则，把一个复杂的功能拆分到多个单一的简单的元功能，不同的元功能组合在一起，和未拆分前完成的功能是一致的，由于每个元功能职责单一、功能简单，让维护和变更都变得更简单、安全，更易于产品版本的迭代。</p>
<p>无论是水平拆分还是垂直拆分，都解决了特定场景下的特定问题，凡事有好的一面，都会有坏的一面，拆分后的系统或者服务化的系统最大的问题就是一致性问题。</p>
<h1 id="解决一致性问题的思路"><a href="#解决一致性问题的思路" class="headerlink" title="解决一致性问题的思路"></a>解决一致性问题的思路</h1><h2 id="酸碱平衡理论"><a href="#酸碱平衡理论" class="headerlink" title="酸碱平衡理论"></a>酸碱平衡理论</h2><p>ACID在英文中的意思是“酸”，BASE的意识是“碱”，这一段讲的是“酸碱平衡”的故事。</p>
<p>ACID<br>如何保证强一致性呢？计算机专业的童鞋在学习关系型数据库的时候都学习了ACID原理，这里对ACID做个简单的介绍。如果想全面的学习ACID原理，请参考ACID。</p>
<p>关系型数据库天生就是解决具有复杂事务场景的问题，关系型数据库完全满足ACID的特性。</p>
<p>ACID指的是：</p>
<ul>
<li>A: Atomicity，原子性</li>
<li>C: Consistency，一致性</li>
<li>I: Isolation，隔离性</li>
<li>D: Durability，持久性</li>
</ul>
<p>具有ACID的特性的数据库支持强一致性，强一致性代表数据库本身不会出现不一致，每个事务是原子的，或者成功或者失败，事物间是隔离的，互相完全不影响，而且最终状态是持久落盘的，因此，数据库会从一个明确的状态到另外一个明确的状态，中间的临时状态是不会出现的，如果出现也会及时的自动的修复，因此是强一致的。</p>
<p>对于案例1，如果能保证把订单和库存放入同一个数据库分片，这样通过关系型数据库自然就解决了不一致的问题。但是由于业务规则的限制，无法将相关的数据分到同一个数据库分片，这个时候我们就需要实现最终一致性</p>
<h2 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h2><p>由于对系统或者数据进行了拆分，我们的系统不再是单机系统，而是分布式系统，针对分布式系的帽子理论包含三个元素：</p>
<p>C：Consistency，一致性, 数据一致更新，所有数据变动都是同步的</p>
<p>A：Availability，可用性, 好的响应性能，完全的可用性指的是在任何故障模型下，服务都会在有限的时间处理响应</p>
<p>P：Partition tolerance，分区容错性，可靠性</p>
<p>帽子理论证明，任何分布式系统只可同时满足二点，没法三者兼顾。</p>
<p><img src="http://oz4nn1wia.bkt.clouddn.com/p1.png" alt="cap"></p>
<p>通常只有CP或者AP模式，因为丢掉了分区容错性，也就失去了分布式本来的意图。</p>
<h2 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h2><p>BASE理论解决CAP理论提出了分布式系统的一致性和可用性不能兼得的问题，BASE在英文中有“碱”的意思，对应本节开头的ACID在英文中“酸”的意思，基于这两个名词提出了酸碱平衡的结论，简单来说是在不同的场景下，可以分别利用ACID和BASE来解决分布式服务化系统的一致性问题。</p>
<p>BASE模型与ACID模型不同，满足CAP理论，通过牺牲强一致性，获得可用性，一般应用在服务化系统的应用层或者大数据处理系统，通过达到最终一致性来尽量满足业务的绝大部分需求。</p>
<p>BASE模型包含个三个元素：</p>
<ul>
<li>BA：Basically Available，基本可用</li>
<li>S：Soft State，软状态，状态可以有一段时间不同步</li>
<li>E：Eventually Consistent，最终一致，最终数据是一致的就可以了，而不是时时保持强一致</li>
</ul>
<p>BASE模型的软状态是实现BASE理论的方法，基本可用和最终一致是目标。按照BASE模型实现的系统，由于不保证强一致性，系统在处理请求的过程中，可以存在短暂的不一致，在短暂的不一致窗口请求处理处在临时状态中，系统在做每步操作的时候，通过记录每一个临时状态，在系统出现故障的时候，可以从这些中间状态继续未完成的请求处理或者退回到原始状态，最后达到一致的状态。</p>
<p>以案例2-转账为例，我们把用户A给用户B转账分成四个阶段，第一个阶段用户A准备转账，第二个阶段从用户A账户扣减余额，第三个阶段对用户B增加余额，第四个阶段完成转账。系统需要记录操作过程中每一步骤的状态，一旦系统出现故障，系统能够自动发现没有完成的任务，然后，根据任务所处的状态，继续执行任务，最终完成任务，达到一致的最终状态。</p>
<h1 id="分布式一致性协议"><a href="#分布式一致性协议" class="headerlink" title="分布式一致性协议"></a>分布式一致性协议</h1><p>国际开放标准组织Open Group定义了DTS（分布式事务处理模型），模型中包含4个角色：应用程序、事务管理器、资源管理器、通信资源管理器四部分。事务处理器是统管全局的管理者，资源处理器和通信资源处理器是事务的参与者。便于展开讨论，我们把事务管理器称为协调者，把资管管理器称为参与者。</p>
<h2 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h2><p>两阶段提交协议把分布式事务分成两个过程，一个是准备阶段，一个是提交阶段，</p>
<p><img src="http://oz4nn1wia.bkt.clouddn.com/p2.jpeg" alt="两阶段提交"></p>
<p>两阶段提交协议在准备阶段锁定资源，是一个重量级的操作，并能保证强一致性，但是实现起来复杂、成本较高，不够灵活，更重要的是它有如下致命的问题：</p>
<p>阻塞：从上面的描述来看，对于任何一次指令必须收到明确的响应，才会继续做下一步，否则处于阻塞状态，占用的资源被一直锁定，不会被释放。</p>
<p>单点故障：如果协调者宕机，参与者没有了协调者指挥，会一直阻塞，尽管可以通过选举新的协调者替代原有协调者，但是如果之前协调者在发送一个提交指令后宕机，而提交指令仅仅被一个参与者接受，并且参与者接收后也宕机，新上任的协调者无法处理这种情况。</p>
<p>脑裂：协调者发送提交指令，有的参与者接收到执行了事务，有的参与者没有接收到事务，就没有执行事务，多个参与者之间是不一致的。</p>
<h2 id="三阶段提交"><a href="#三阶段提交" class="headerlink" title="三阶段提交"></a>三阶段提交</h2><p>三阶段提交协议是两阶段提交协议的改进版本，通过超时机制解决了阻塞的问题，在二阶段提交之前增加了询问阶段。</p>
<p><img src="http://oz4nn1wia.bkt.clouddn.com/p3.jpeg" alt="三阶段提交"></p>
<p>这里与两阶段提交协议有两个主要的不同：</p>
<ul>
<li><p>增加了一个询问阶段，询问阶段可以确保尽可能早的发现无法执行操作而需要中止的行为，但是它并不能发现所有的这种行为，只会减少这种情况的发生。</p>
</li>
<li><p>在准备阶段以后，协调者和参与者执行的任务中都增加了超时，一旦超时，协调者和参与者都继续提交事务，默认为成功，这也是根据概率统计上超时后默认成功的正确性最大。</p>
</li>
</ul>
<p>三阶段提交协议与两阶段提交协议相比，具有如上的优点，但是一旦发生超时，系统仍然会发生不一致，只不过这种情况很少见罢了，好处就是至少不会阻塞和永远锁定资源。</p>
<h1 id="分布式一致性问题解决方案——paxos"><a href="#分布式一致性问题解决方案——paxos" class="headerlink" title="分布式一致性问题解决方案——paxos"></a>分布式一致性问题解决方案——paxos</h1><p><a href="https://www.cnblogs.com/linbingdong/p/6253479.html" target="_blank" rel="noopener">https://www.cnblogs.com/linbingdong/p/6253479.html</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>还有一些关于分布式一致性的技术无法在一篇文章中与大家分享，包括：raft算法、zab算法、nwr算法、一致性哈希等。</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>《从paxos到Zookeeper分布式一致性原理和实践》</li>
<li>《分布式服务架构：原理、设计和实战》</li>
</ul>
<p>基础概念介绍：<a href="https://www.cnblogs.com/szlbm/p/5588543.html" target="_blank" rel="noopener">https://www.cnblogs.com/szlbm/p/5588543.html</a></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/eth.png">
        <p> 感谢支持(ETH:0xB0CAC88b5B5F893dD05aa46F0f7d9708C4dAFA3b) </p>
    </div>
</div>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        <li>
            <a target="_blank" href="https://twitter.com/shallotsh">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-twitter"></i>
                            </span>
            </a>
        </li>
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/indexdance">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/shallotsh">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank"  href="https://www.linkedin.com/in/亚武-黄-728a37101">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-linkedin"></i>
                            </span>
            </a>
        </li>
        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.github.com">GitHub</a></span>
        <span>/</span>
        
        <span><a href="http://ifeve.com/">并发编程网</a></span>
        <span>/</span>
        
        <span><a href="https://tech.meituan.com/">美团技术博客</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Hosted by <a href="https://pages.coding.me" style="font-weight: bold;">Coding Pages</a> Created By <a href="https://hexo.io/">Hexo</a> 
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: '分布式一致性基础',
        owner: 'shallotsh',
        repo: 'shallotsh.github.io',
        oauth: {
            client_id: 'b3260fcb1f223a89bf9c',
            client_secret: '989da3c54db88efce806e490362c800efe7d886f',
        },
    })
    gitment.render('comment-container')
</script>


</html>
